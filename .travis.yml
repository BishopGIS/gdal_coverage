# This is the config file for building GDAL and running its autotest suite
# with Travis-ci.org on a Mac-OSX machine

language: objective-c
osx_image: xcode8

# We use clang, --without-libtool and --with-debug for faster build
compiler:
  - clang

# Could probably drop the osx check.
before_install:
  - ls -l /usr/lib | grep sqlite
  - otool -L /usr/lib/libsqlite3.dylib
  - brew update
  - brew uninstall gdal
  - brew install sqlite3
  - brew cleanup

install:
# build proj
  - brew list --versions
  - echo "Where is sqlite coming from?  homebrew or system?"
  - brew info sqlite3
  - brew ls --verbose sqlite3
  - mdfind libsqlite3 | egrep '[.](dylib|so|la|a)$'
  - mdfind sqlite3.h | grep sqlite3.h
  - ls -l /usr/lib/*sqlite*
  - grep SQLITE_VERSION /usr/include/sqlite3.h
  - ls -l /usr/lib/libsqlite*
  - ls /usr/local/lib
  - ls /usr/local/include
  - curl http://download.osgeo.org/proj/proj-4.9.3.tar.gz > proj-4.9.3.tar.gz
  - tar xvzf proj-4.9.3.tar.gz
  - cd proj-4.9.3/nad
  - curl http://download.osgeo.org/proj/proj-datumgrid-1.5.tar.gz > proj-datumgrid-1.5.tar.gz
  - tar xvzf proj-datumgrid-1.5.tar.gz
  - cd ..
  - ./configure --prefix=$HOME/install-proj
  - make -j3
  - make install
  - cd ..
# build GDAL
  - cd gdal
  - ./configure --prefix=$HOME/install-gdal --enable-debug --with-jpeg12 --with-python --with-geotiff=internal --with-png=internal --with-static-proj4=$HOME/install-proj
  - grep -i sqlite config.*
  - make USER_DEFS="-Wextra -Werror" -j3
  - cd apps
  - make USER_DEFS="-Wextra -Werror" test_ogrsf
  - echo "Show which shared libs got used:"
  - otool -L .libs/ogrinfo
  - otool -L /usr/lib/libsqlite3.dylib
  - cd ..
  - make install
  - export PATH=$HOME/install-gdal/bin:$PWD/apps/.libs:$PATH
  - export DYLD_LIBRARY_PATH=$HOME/install-gdal/lib
  - export GDAL_DATA=$HOME/install-gdal/share/gdal
  - export PYTHONPATH=$PWD/swig/python/build/lib.macosx-10.11-x86_64-2.7
  - cd ../autotest/cpp
  - echo $PATH
#  - sudo rm -rf /usr/local/Cellar/gdal/1.10.1_1/*
#  - sudo ln -s /usr/bin /usr/local/Cellar/gdal/1.10.1_1
#  - sudo ln -s /usr/lib /usr/local/Cellar/gdal/1.10.1_1
#  - sudo ln -s /usr/include /usr/local/Cellar/gdal/1.10.1_1
#  - sudo mkdir /usr/local/Cellar/gdal/1.10.1_1/share
#  - sudo ln -s /usr/share/gdal /usr/local/Cellar/gdal/1.10.1_1/share
  - gdal-config --version
  - gdal-config --cflags
  - gdal-config --libs
  - make -j3
  - cd ../../gdal

script:
# CPP unit tests
  - cd ../autotest
  - cd cpp
  - GDAL_SKIP=JP2ECW make quick_test
  - cd ..
# Run all the Python autotests
#  - make -j test
  - brew install valgrind
  - cd ogr
  - valgrind python ogr_gpkg.py
  - cd ..
  - python run_all.py

notifications:
  email:
    recipients:
      - gdal-commits@lists.osgeo.org

  irc:
    channels:
      - "irc.freenode.org#gdal"
    use_notice: true
    on_success: change
